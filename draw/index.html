<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="joint.min.css" />
<script src="joint.min.js"></script>
<title>Insert title here</title>
</head>
<body>
<button id="add_link">Add Connection</button>
<button id="save">Save</button>
<div id="myholder"></div>
<script>
var API = 'http://api.casco.me/';
var graph = new joint.dia.Graph;

var paper = new joint.dia.Paper({
    el: $('#myholder'),
    width: 600,
    height: 600,
    model: graph,
    gridSize: 1
});
var project_id = location.href.substr(location.href.indexOf('?')+1);
var url = API+'project/'+project_id;
var initnew = function(){
	$.ajax({
		url: url,
		success: function(project){
			var documents = project.documents;
			var v_rs = v_tc = 50;
			$.each(documents, function(index, document){
				if(document.type == 'rs'){
					var rect = new joint.shapes.basic.Rect({
					    position: { x: 100, y: v_rs },
					    size: { width: 150, height: 30 },
					    attrs: { rect: { fill: '#E74C3C' }, text: { text: document.name, fill: 'white' } }
					});
					graph.addCell(rect);
					v_rs += 70;
				}else if(document.type == 'tc'){
					var rect = new joint.shapes.basic.Rect({
					    position: { x: 400, y: v_tc },
					    size: { width: 150, height: 30 },
					    attrs: { rect: { fill: '#8E44AD' }, text: { text: document.name, fill: 'white' } }
					});
					graph.addCell(rect);
					v_tc += 70;
				}
			})
		}
	});
};
$(function(){
	$.ajax({
		url: url,
		success: function(d){
			if(d.graph){
				graph.fromJSON(JSON.parse(d.graph));
			}else{
				initnew();
			}
		}
	})
	
	$("#add_link").click(function(){
		var link = new joint.dia.Link({
			source: {x: 175, y: 25},
			target: {x: 475, y: 25}
		});
		graph.addCell(link);console.log(graph.toJSON())
	});
	$("#save").click(function(){
		$.ajax({
			url: url,
			method: 'PUT',
			data: {
				graph: JSON.stringify(graph.toJSON())
			},
			success: function(){
				alert("Success");
			}
		});
	})
})
</script>
</body>
</html>